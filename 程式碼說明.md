# 程式碼說明文件

## 儲存文字至txt檔功能實作說明

本文件詳細說明為了實作「儲存文字至txt檔」功能所新增和修改的程式碼。

---

## 一、mainwindow.h 檔案修改

### 修改位置：第15-21行

```cpp
private slots:
    void on_actionDarkMode_toggled(bool checked);
    void on_actionSave_triggered();
    void on_actionASave_triggered();

private:
    QString currentFilePath;
```

### 逐行說明：

**第15行：`private slots:`**
- 宣告私有槽函數區段
- 槽（slot）是Qt的訊號槽機制中的接收端，用於回應使用者介面的訊號

**第16行：`void on_actionDarkMode_toggled(bool checked);`**
- 原有的深色模式切換函數宣告（未修改）
- 當使用者切換深色模式時會呼叫此函數

**第17行：`void on_actionSave_triggered();`**
- **新增**：宣告儲存檔案的槽函數
- 當使用者點擊「儲存」選單或按下Ctrl+S時會自動呼叫此函數
- Qt的自動連接機制會根據物件名稱（actionSave）自動連接此槽函數

**第18行：`void on_actionASave_triggered();`**
- **新增**：宣告另存新檔的槽函數
- 當使用者點擊「另存新檔」選單時會自動呼叫此函數
- Qt的自動連接機制會根據物件名稱（actionASave）自動連接此槽函數

**第19行：空白行**
- 用於分隔槽函數區段和私有成員變數區段

**第20行：`private:`**
- 宣告私有成員變數區段
- 私有成員只能被類別內部的函數存取

**第21行：`QString currentFilePath;`**
- **新增**：宣告一個字串變數用於儲存當前開啟檔案的路徑
- QString是Qt提供的字串類別
- 此變數用於記住檔案的儲存位置，以便「儲存」功能可以直接覆寫原檔案
- 若此變數為空（isEmpty），表示尚未儲存過檔案，需要開啟另存新檔對話框

---

## 二、mainwindow.cpp 檔案修改

### 修改部分1：第1-6行（標頭檔引入）

```cpp
#include "mainwindow.h"
#include "ui_mainwindow.h"
#include <QFileDialog>
#include <QTextStream>
#include <QMessageBox>
#include <QFile>
```

### 逐行說明：

**第1行：`#include "mainwindow.h"`**
- 引入主視窗的標頭檔（原有，未修改）
- 包含MainWindow類別的宣告

**第2行：`#include "ui_mainwindow.h"`**
- 引入Qt Designer自動產生的使用者介面標頭檔（原有，未修改）
- 包含UI元件的定義

**第3行：`#include <QFileDialog>`**
- **新增**：引入Qt的檔案對話框類別
- 用於顯示「另存新檔」對話框，讓使用者選擇儲存檔案的位置和名稱

**第4行：`#include <QTextStream>`**
- **新增**：引入Qt的文字串流類別
- 用於將文字內容寫入檔案
- 提供方便的文字讀寫介面

**第5行：`#include <QMessageBox>`**
- **新增**：引入Qt的訊息對話框類別
- 用於顯示錯誤訊息或警告訊息給使用者
- 例如：當檔案無法寫入時顯示警告

**第6行：`#include <QFile>`**
- **新增**：引入Qt的檔案類別
- 用於進行檔案的開啟、讀取、寫入等操作
- 提供低階的檔案存取功能

---

### 修改部分2：第58-80行（儲存功能實作）

```cpp
void MainWindow::on_actionSave_triggered()
{
    // 如果尚未設定檔案路徑，則呼叫另存新檔功能
    if (currentFilePath.isEmpty()) {
        on_actionASave_triggered();
        return;
    }
    
    // 開啟檔案進行寫入
    QFile file(currentFilePath);
    if (!file.open(QIODevice::WriteOnly | QIODevice::Text)) {
        QMessageBox::warning(this, "儲存失敗", "無法寫入檔案：" + currentFilePath);
        return;
    }
    
    // 將文字編輯器的內容寫入檔案
    QTextStream out(&file);
    out << textEdit->toPlainText();
    file.close();
    
    // 顯示儲存成功訊息
    statusbar->showMessage("檔案已儲存：" + currentFilePath, 3000);
}
```

### 逐行說明：

**第58行：`void MainWindow::on_actionSave_triggered()`**
- **新增**：定義儲存檔案的槽函數
- 這是MainWindow類別的成員函數
- 當使用者點擊「儲存」或按Ctrl+S時會執行此函數

**第59行：`{`**
- 函數主體開始

**第60行：`// 如果尚未設定檔案路徑，則呼叫另存新檔功能`**
- 註解：說明接下來的程式碼用途

**第61行：`if (currentFilePath.isEmpty()) {`**
- 檢查currentFilePath變數是否為空字串
- isEmpty()是QString類別的成員函數，用於判斷字串是否為空
- 如果為空，表示這是第一次儲存檔案，尚未指定儲存位置

**第62行：`on_actionASave_triggered();`**
- 呼叫另存新檔函數
- 讓使用者選擇儲存位置和檔案名稱
- 執行完畢後會設定currentFilePath變數

**第63行：`return;`**
- 結束此函數的執行
- 因為另存新檔函數內部會再次呼叫本函數進行實際儲存

**第64行：`}`**
- if條件區塊結束

**第65行：空白行**
- 增加程式碼可讀性

**第66行：`// 開啟檔案進行寫入`**
- 註解：說明接下來要開啟檔案

**第67行：`QFile file(currentFilePath);`**
- 建立QFile物件
- 參數是檔案路徑（currentFilePath）
- 此時尚未真正開啟檔案，只是建立檔案物件

**第68行：`if (!file.open(QIODevice::WriteOnly | QIODevice::Text)) {`**
- 嘗試以寫入模式開啟檔案
- QIODevice::WriteOnly：表示以唯寫模式開啟
- QIODevice::Text：表示以文字模式開啟（會自動處理換行符號）
- 使用位元OR運算子（|）結合兩個模式
- 如果開啟失敗，file.open()會返回false
- !符號表示邏輯NOT，所以整個條件是「如果開啟失敗」

**第69行：`QMessageBox::warning(this, "儲存失敗", "無法寫入檔案：" + currentFilePath);`**
- 顯示警告訊息對話框
- 第一個參數(this)：對話框的父視窗
- 第二個參數("儲存失敗")：對話框的標題
- 第三個參數：對話框的內容訊息，包含無法寫入的檔案路徑
- 使用+運算子連接字串

**第70行：`return;`**
- 結束函數執行
- 因為檔案開啟失敗，無法繼續進行儲存操作

**第71行：`}`**
- if條件區塊結束

**第72行：空白行**
- 增加程式碼可讀性

**第73行：`// 將文字編輯器的內容寫入檔案`**
- 註解：說明接下來要寫入文字內容

**第74行：`QTextStream out(&file);`**
- 建立文字串流物件
- 參數&file是QFile物件的指標
- QTextStream提供方便的文字寫入介面
- 類似於C++的iostream

**第75行：`out << textEdit->toPlainText();`**
- 將文字編輯器的內容寫入檔案
- textEdit是UI中的QTextEdit元件
- toPlainText()方法取得純文字內容（不含格式）
- <<運算子將文字寫入串流（進而寫入檔案）

**第76行：`file.close();`**
- 關閉檔案
- 確保資料完全寫入磁碟
- 釋放檔案資源

**第77行：空白行**
- 增加程式碼可讀性

**第78行：`// 顯示儲存成功訊息`**
- 註解：說明接下來要顯示成功訊息

**第79行：`statusbar->showMessage("檔案已儲存：" + currentFilePath, 3000);`**
- 在狀態列顯示儲存成功訊息
- statusbar是UI中的QStatusBar元件
- showMessage()方法在狀態列顯示訊息
- 第一個參數：要顯示的訊息文字
- 第二個參數(3000)：訊息顯示時間，單位是毫秒（3秒）
- 3秒後訊息會自動消失

**第80行：`}`**
- 函數主體結束

---

### 修改部分3：第82-102行（另存新檔功能實作）

```cpp
void MainWindow::on_actionASave_triggered()
{
    // 開啟另存新檔對話框
    QString fileName = QFileDialog::getSaveFileName(
        this,
        "另存新檔",
        "",
        "文字檔案 (*.txt);;所有檔案 (*.*)"
    );
    
    // 如果使用者取消選擇，則返回
    if (fileName.isEmpty()) {
        return;
    }
    
    // 更新當前檔案路徑
    currentFilePath = fileName;
    
    // 呼叫儲存功能
    on_actionSave_triggered();
}
```

### 逐行說明：

**第82行：`void MainWindow::on_actionASave_triggered()`**
- **新增**：定義另存新檔的槽函數
- 這是MainWindow類別的成員函數
- 當使用者點擊「另存新檔」選單時會執行此函數

**第83行：`{`**
- 函數主體開始

**第84行：`// 開啟另存新檔對話框`**
- 註解：說明接下來要開啟檔案選擇對話框

**第85-89行：`QString fileName = QFileDialog::getSaveFileName(...);`**
- 呼叫靜態函數開啟儲存檔案對話框
- QFileDialog::getSaveFileName()是Qt提供的標準檔案儲存對話框
- 返回值是使用者選擇的檔案路徑（QString類型）

**第86行：`this,`**
- 第一個參數：對話框的父視窗
- this指向目前的MainWindow物件

**第87行：`"另存新檔",`**
- 第二個參數：對話框的標題文字

**第88行：`"",`**
- 第三個參數：預設的檔案路徑
- 空字串表示使用系統預設的儲存位置（通常是我的文件）

**第89行：`"文字檔案 (*.txt);;所有檔案 (*.*)"`**
- 第四個參數：檔案類型過濾器
- 雙分號(;;)用於分隔不同的檔案類型
- "文字檔案 (*.txt)"：第一個選項，只顯示.txt檔案
- "所有檔案 (*.*)"：第二個選項，顯示所有檔案
- 使用者可以在對話框中切換這些選項

**第90行：`);`**
- 函數呼叫結束

**第91行：空白行**
- 增加程式碼可讀性

**第92行：`// 如果使用者取消選擇，則返回`**
- 註解：說明接下來處理使用者取消的情況

**第93行：`if (fileName.isEmpty()) {`**
- 檢查fileName是否為空字串
- 如果使用者在對話框中按下「取消」按鈕，getSaveFileName()會返回空字串
- isEmpty()判斷字串是否為空

**第94行：`return;`**
- 結束函數執行
- 使用者取消操作，不進行任何儲存動作

**第95行：`}`**
- if條件區塊結束

**第96行：空白行**
- 增加程式碼可讀性

**第97行：`// 更新當前檔案路徑`**
- 註解：說明接下來要更新檔案路徑變數

**第98行：`currentFilePath = fileName;`**
- 將使用者選擇的檔案路徑存入成員變數
- 之後使用「儲存」功能時就可以直接使用此路徑
- 不需要每次都開啟對話框

**第99行：空白行**
- 增加程式碼可讀性

**第100行：`// 呼叫儲存功能`**
- 註解：說明接下來要執行實際的儲存操作

**第101行：`on_actionSave_triggered();`**
- 呼叫儲存函數進行實際的檔案寫入
- 重複使用儲存函數的程式碼，避免程式碼重複
- 此時currentFilePath已經有值，所以會直接執行檔案寫入

**第102行：`}`**
- 函數主體結束

---

## 三、功能流程說明

### 儲存功能（Ctrl+S 或點擊儲存按鈕）：

1. 使用者觸發儲存動作
2. 執行 `on_actionSave_triggered()` 函數
3. 檢查 `currentFilePath` 是否為空：
   - 如果為空（第一次儲存）：呼叫 `on_actionASave_triggered()` 開啟另存新檔對話框
   - 如果不為空（已有儲存路徑）：直接儲存到該路徑
4. 開啟檔案進行寫入
5. 使用 `QTextStream` 將 `textEdit` 的內容寫入檔案
6. 關閉檔案
7. 在狀態列顯示成功訊息

### 另存新檔功能（點擊另存新檔選單）：

1. 使用者觸發另存新檔動作
2. 執行 `on_actionASave_triggered()` 函數
3. 開啟 `QFileDialog` 對話框讓使用者選擇儲存位置和檔案名稱
4. 如果使用者取消，結束函數
5. 如果使用者選擇了檔案，更新 `currentFilePath` 變數
6. 呼叫 `on_actionSave_triggered()` 執行實際的儲存操作

---

## 四、技術重點總結

1. **Qt訊號槽機制**：使用Qt的自動連接功能，根據函數命名規則自動連接UI元件的訊號和槽函數

2. **檔案路徑管理**：使用 `currentFilePath` 成員變數記住檔案位置，實現「儲存」和「另存新檔」功能的差異

3. **錯誤處理**：檔案開啟失敗時顯示警告訊息，提升使用者體驗

4. **程式碼重用**：「另存新檔」功能最終呼叫「儲存」功能，避免程式碼重複

5. **使用者回饋**：在狀態列顯示儲存成功訊息，讓使用者知道操作已完成

---

## 五、測試建議

1. **第一次儲存測試**：
   - 在文字編輯器中輸入內容
   - 按Ctrl+S
   - 應該會開啟另存新檔對話框
   - 選擇儲存位置和檔案名稱
   - 確認檔案已正確儲存

2. **覆寫儲存測試**：
   - 修改已儲存的檔案內容
   - 再次按Ctrl+S
   - 應該直接覆寫原檔案，不再開啟對話框

3. **另存新檔測試**：
   - 開啟已有檔案路徑的文件
   - 點擊「另存新檔」選單
   - 應該開啟對話框讓使用者選擇新的儲存位置

4. **取消操作測試**：
   - 點擊儲存或另存新檔
   - 在對話框中按「取消」
   - 應該不進行任何操作，也不顯示錯誤訊息

5. **錯誤處理測試**：
   - 嘗試儲存到唯讀位置或無權限的位置
   - 應該顯示警告訊息

---

## 六、結論

本次修改實作了完整的「儲存文字至txt檔」功能，包含：

- **mainwindow.h**：新增2個槽函數宣告和1個成員變數（共3行新增）
- **mainwindow.cpp**：新增4個標頭檔引入和2個完整的函數實作（共47行新增）

總計新增**50行程式碼**，實作了儲存和另存新檔兩個功能，具備完善的錯誤處理和使用者回饋機制。
